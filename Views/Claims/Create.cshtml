@model CMCSPART3.Models.Claim

@{
    ViewData["Title"] = "Submit Claim";
}

<h2 class="text-center mb-4">Submit Claim</h2>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<form asp-action="Create" enctype="multipart/form-data" method="post">

    <!-- ============================ -->
    <!--  LECTURER ID FIRST (Editable) -->
    <!-- ============================ -->
    <div class="form-group mb-3">
        <label asp-for="LecturerId"><strong>Lecturer ID</strong></label>
        <input asp-for="LecturerId" class="form-control" />
        <span asp-validation-for="LecturerId" class="text-danger"></span>
    </div>

    <hr />

    <!-- ============================ -->
    <!--  CLAIM INPUT FIELDS          -->
    <!-- ============================ -->
    <div class="form-group mb-3">
        <label asp-for="HoursWorked"><strong>Hours Worked</strong></label>
        <input asp-for="HoursWorked" type="number" class="form-control" id="hoursWorked" />
        <span asp-validation-for="HoursWorked" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label asp-for="HourlyRate"><strong>Hourly Rate (ZAR)</strong></label>
        <input asp-for="HourlyRate" type="number" step="0.01" class="form-control" id="hourlyRate" />
        <span asp-validation-for="HourlyRate" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label><strong>Calculated Claim Amount</strong></label>
        <input id="calculatedAmount" class="form-control" readonly />
        <input type="hidden" asp-for="ClaimAmount" id="claimAmountHidden" />
    </div>

    <div class="form-group mb-3">
        <label asp-for="Notes"><strong>Notes (Optional)</strong></label>
        <textarea asp-for="Notes" class="form-control"></textarea>
    </div>

    <hr />

    <!-- ============================ -->
    <!-- FILE UPLOAD SECTION          -->
    <!-- ============================ -->
    <h4>Supporting Document</h4>
    <p>@ViewBag.MaxFileSize</p>

    <div class="form-group">
        <input type="file" name="SupportingDocument" id="supportingDocument" class="form-control" />
        <span id="fileError" class="text-danger"></span>
    </div>

    <hr />

    <button type="submit" id="submitBtn" class="btn btn-primary w-100 mt-3">Submit Claim</button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>

        // ============================
        // AUTO CALCULATE CLAIM AMOUNT
        // ============================
        function calculateAmount() {
            let hours = parseFloat(document.getElementById("hoursWorked").value) || 0;
            let rate = parseFloat(document.getElementById("hourlyRate").value) || 0;

            if (hours > 180) {
                alert("You cannot claim more than 180 hours.");
                hours = 180;
                document.getElementById("hoursWorked").value = 180;
            }

            let total = hours * rate;

            document.getElementById("calculatedAmount").value = total.toFixed(2);
            document.getElementById("claimAmountHidden").value = total.toFixed(2);
        }

        document.getElementById("hoursWorked").addEventListener("input", calculateAmount);
        document.getElementById("hourlyRate").addEventListener("input", calculateAmount);

        // ============================
        // FILE VALIDATION
        // ============================
        document.getElementById("supportingDocument").addEventListener("change", function () {
            const allowedExt = [".pdf", ".docx", ".xlsx"];
            const fileInput = this;
            const fileError = document.getElementById("fileError");
            fileError.textContent = "";

            let file = fileInput.files[0];

            if (file) {
                let fileName = file.name.toLowerCase();
                let valid = allowedExt.some(ext => fileName.endsWith(ext));

                if (!valid) {
                    fileError.textContent = "Invalid file type.";
                    fileInput.value = "";
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    fileError.textContent = "File too large. Max 5 MB.";
                    fileInput.value = "";
                }
            }
        });

    </script>
}
