@model CMCSP3.Models.Claim

@{
    ViewData["Title"] = "Submit Claim";
    // Parse the hourly rate from ViewBag to a numeric type for the script
    // Assuming ViewBag.HourlyRate is a string like "150.00" or a decimal
    decimal hourlyRate = 0;
    if (ViewBag.HourlyRate != null)
    {
        decimal.TryParse(ViewBag.HourlyRate.ToString(), out hourlyRate);
    }
}

<h2>Submit Claim</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<form asp-action="Create" enctype="multipart/form-data" method="post">
    @Html.AntiForgeryToken()

    <div class="form-group">
        <label>Lecturer:</label>
        <p>@ViewBag.FirstName @ViewBag.LastName</p>
        <input type="hidden" name="LecturerId" value="@ViewBag.LecturerId" />
    </div>

    <div class="form-group">
        <label>Hourly Rate:</label>
        <p>R <span id="hourlyRateDisplay">@hourlyRate.ToString("F2")</span></p>
        <input type="hidden" name="HourlyRate" id="hourlyRateInput" value="@hourlyRate.ToString("F2")" />
    </div>

    <div class="form-group">
        <label asp-for="HoursWorked"></label>
        <input asp-for="HoursWorked" id="hoursWorkedInput" class="form-control" type="number" step="0.5" min="0" />
        <span asp-validation-for="HoursWorked" class="text-danger"></span>
    </div>

    <div class="form-group alert alert-info">
        <label>Calculated Total Claim Amount:</label>
        <p class="lead"><strong>R <span id="totalClaimAmount">0.00</span></strong></p>
    </div>

    <div class="form-group">
        <label asp-for="TaskDescription"></label>
        <textarea asp-for="TaskDescription" class="form-control"></textarea>
        <span asp-validation-for="TaskDescription" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>Supporting Document:</label>
        <input type="file" name="SupportingDocument" class="form-control" />
        <small class="form-text text-muted">@ViewBag.MaxFileSize</small>
    </div>

    <button type="submit" class="btn btn-primary">Submit Claim</button>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {
            // Function to perform the calculation and update the display
            function calculateTotalClaim() {
                // Get the values
                var hoursWorked = parseFloat($('#hoursWorkedInput').val()) || 0;
                // Use the value from the hidden input for the calculation
                var hourlyRate = parseFloat($('#hourlyRateInput').val()) || 0;

                // Calculate the total
                var totalAmount = hoursWorked * hourlyRate;

                // Format the total to two decimal places and update the display
                // Use toLocaleString for currency formatting (optional, but good practice)
                $('#totalClaimAmount').text(totalAmount.toFixed(2));
            }

            // Bind the calculation function to the input event of the HoursWorked field
            $('#hoursWorkedInput').on('input', calculateTotalClaim);

            // Run the calculation once on page load in case there's an initial value
            calculateTotalClaim();
        });
    </script>
}